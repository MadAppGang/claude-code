name: Publish to npm

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.3.0
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run (skip actual publish)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write  # Required for npm OIDC trusted publishing

jobs:
  publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Verify npm version supports OIDC
        run: |
          NPM_VERSION=$(npm --version)
          echo "npm version: $NPM_VERSION"
          # OIDC requires npm >= 11.5.1
          if ! npx semver -r ">=11.5.1" "$NPM_VERSION" > /dev/null 2>&1; then
            echo "Updating npm to support OIDC trusted publishing..."
            npm install -g npm@latest
            echo "Updated npm version: $(npm --version)"
          fi

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Verify build
        run: |
          if [ ! -d "dist" ]; then
            echo "Build failed: dist directory not found"
            exit 1
          fi
          echo "Build successful, dist contents:"
          ls -la dist/

      - name: Publish to npm (dry run)
        if: ${{ inputs.dry-run == true }}
        run: npm publish --dry-run

      - name: Publish to npm
        if: ${{ inputs.dry-run != true }}
        run: npm publish --access public

      - name: Get package info
        id: package
        run: |
          echo "name=$(node -p "require('./package.json').name")" >> $GITHUB_OUTPUT
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## Published :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** ${{ steps.package.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.package.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install -g ${{ steps.package.outputs.name }}@${{ steps.package.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
